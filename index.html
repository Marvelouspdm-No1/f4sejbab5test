<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <title>F4 Sejarah Bab 5 Quiz</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f2f2f2;
            max-width: 800px;
            margin: 0 auto;
        }
        .question {
            background: #fff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .result {
            background: #e6ffe6;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .history {
            background: #e6f3ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .hidden {
            display: none;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #ddd;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .correct {
            color: green;
        }
        .incorrect {
            color: red;
        }
        .save-buttons {
            margin-top: 20px;
            text-align: center;
        }
        .save-btn {
            background-color: #2196F3;
            margin: 5px;
        }
        .save-btn:hover {
            background-color: #0b7dda;
        }
        .download-btn {
            background-color: #FF6B35;
            margin: 5px;
        }
        .download-btn:hover {
            background-color: #E55A2B;
        }
        #reportCanvas {
            text-align: center;
        }
        .canvas-container {
            display: inline-block;
            margin: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        label {
            display: block;
            margin: 8px 0;
            cursor: pointer;
            padding: 15px 12px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            background-color: #fff;
            transition: all 0.3s ease;
            font-size: 16px;
            line-height: 1.4;
            min-height: 50px;
            display: flex;
            align-items: center;
        }
        label:hover {
            background-color: #f5f5f5;
            border-color: #2196F3;
        }
        label:active {
            background-color: #e3f2fd;
        }
        input[type="radio"] {
            margin-right: 12px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }
        input[type="radio"]:checked + span {
            font-weight: bold;
            color: #2196F3;
        }
        label.selected {
            background-color: #e3f2fd;
            border-color: #2196F3;
            font-weight: bold;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 16px;
            }
            .question {
                padding: 20px 15px;
                margin-bottom: 15px;
            }
            label {
                padding: 18px 15px;
                font-size: 17px;
                min-height: 60px;
            }
            input[type="radio"] {
                width: 22px;
                height: 22px;
                margin-right: 15px;
            }
            button {
                padding: 15px 25px;
                font-size: 17px;
                margin: 8px 5px;
                width: 100%;
                max-width: 300px;
            }
            h2 {
                font-size: 20px;
                line-height: 1.3;
            }
            .info-box {
                padding: 15px 12px;
                font-size: 15px;
            }
            .tab {
                padding: 12px 15px;
                font-size: 16px;
            }
        }
        .info-box {
            background: #e6f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>

<h2>F4 Sejarah Bab 5 Quiz - Persekutuan Tanah Melayu 1948</h2>
<div class="info-box">
    <p><strong>💡 温馨提示：</strong></p>
    <p>• 🖼️ <strong>生成成绩单图片</strong> - 制作正式的成绩单图片，可保存和分享</p>
    <p>• 💾 <strong>保存进度功能</strong> - 可以随时保存测验进度，稍后继续作答</p>
    <p>• 📚 本测验涵盖Persekutuan Tanah Melayu 1948的重要知识点</p>
    <p>• 📱 手机端已优化，选项按钮更大更容易点击</p>
</div>

<div class="tabs">
    <div class="tab active" onclick="showTab('quiz')">做测验</div>
    <div class="tab" onclick="showTab('history')">查看记录</div>
</div>

<div id="quiz" class="tab-content active">
    <form id="quizForm">
        <label>Name (名字):</label><br>
        <input type="text" id="name" required><br><br>

        <label>Form (年级):</label><br>
        <select id="form" required>
            <option value="">Select</option>
            <option value="F1">F1</option>
            <option value="F2">F2</option>
            <option value="F3">F3</option>
            <option value="F4">F4</option>
            <option value="F5">F5</option>
        </select><br><br>

        <div id="questions"></div>

        <button type="button" onclick="submitQuiz()">提交答案</button>
        <button type="button" onclick="saveProgress()">保存进度</button>
        <button type="button" onclick="loadProgress()">加载进度</button>
    </form>

    <div id="result" class="result hidden"></div>
</div>

<div id="history" class="tab-content">
    <h3>你的测验记录</h3>
    <div id="historyList"></div>
</div>

<script>
const questions = [
    {
        q: "Persekutuan Tanah Melayu diperkenalkan bagi menggantikan Malayan Union 1946 yang ditolak oleh siapakah?",
        options: ["Rakyat tempatan", "Golongan radikal", "Pentadbir British", "Pemimpin parti"],
        answer: "Rakyat tempatan",
        explain: "Persekutuan Tanah Melayu 1948 diperkenalkan untuk menggantikan Malayan Union 1946 yang ditolak oleh penduduk tempatan, terutamanya orang Melayu yang tidak bersetuju dengan syarat-syarat dalam Malayan Union.",
        encourage: "很好！你掌握了PTM 1948成立的基本背景。继续保持这种学习态势！"
    },
    {
        q: "Siapakah yang menjadi wakil Raja-Raja Melayu dalam penubuhan Jawatankuasa Kerja pada tahun 1946?",
        options: ["Dato Onn Jaafar", "Haji Megat Yunus", "Tunku Abdul Rahman", "Dato'Nik Ahmed Kamil Mahmud"],
        answer: "Dato'Nik Ahmed Kamil Mahmud",
        explain: "Dato'Nik Ahmad Kamil Mahmud - Dato'Seri Setia Raja Kelantan adalah salah seorang wakil Raja-raja Melayu dalam Jawatankuasa Kerja, bersama dengan Raja Kamaralzaman Raja Ngah Mansur, Dato' Hamzah Abdullah, dan Haji Mohanad Sheriff Osman.",
        encourage: "出色！你能准确识别工作委员会中的马来统治者代表。历史人物的掌握很重要！"
    },
    {
        q: "Mengapakah British menubuhkan Jawatankuasa Kerja pada 25 Julai 1946?",
        options: ["Memeriksa Perlembagaan Rakyat", "Menilai pelaksanaan Malayan Union", "Memperkenalkan Dasar Pendidikan Kebangsaan", "Merangka Perjanjian Persekutuan Tanah Melayu"],
        answer: "Merangka Perjanjian Persekutuan Tanah Melayu",
        explain: "Jawatankuasa Kerja ditubuhkan khusus untuk membincangkan asas dan merangka Perjanjian Persekutuan Tanah Melayu 1948 sebagai pengganti kepada Malayan Union.",
        encourage: "太棒了！你理解了工作委员会的主要目的。政治发展的脉络很重要！"
    },
    {
        q: "Antara berikut, tokoh manakah merupakan wakil Raja-raja Melayu dalam Jawatankuasa Kerja? I. Haji Megat Yunus II. Dato Hamzah Abdullah III. Haji Mohamad Sheriff Osman IV. Dato Abdul Rahman Mohd Yassin",
        options: ["I dan II", "I dan IV", "II dan III", "III dan IV"],
        answer: "II dan III",
        explain: "Dato Hamzah Abdullah (Orang Kaya Menteri Besar Selangor) dan Haji Mohamad Sheriff Osman (Setiausaha Kerajaan Kedah) adalah wakil Raja-raja Melayu dalam Jawatankuasa Kerja.",
        encourage: "非常好！你能区分不同类别的代表。细节掌握得很好！"
    },
    {
        q: "Jawatankuasa Kerja dibentuk untuk merangka Perjanjian Persekutuan Tanah Melayu 1948. Apakah cadangan yang disediakan oleh Jawatankuasa tersebut? I. Menjaga kedudukan istimewa orang Melayu II. Memulihkan kedudukan Raja-raja Melayu III. Menyatukan Tanah Melayu dengan Singapura IV. Membentuk sebuah kerajaan pusat yang kuat",
        options: ["I dan II", "I dan IV", "II dan III", "III dan IV"],
        answer: "I dan II",
        explain: "Jawatankuasa Kerja mencadangkan untuk menjaga kedudukan istimewa orang Melayu dan memulihkan kedudukan serta kedaulatan Raja-raja Melayu.",
        encourage: "优秀！你掌握了工作委员会的主要建议。这些都是PTM 1948的核心特征！"
    },
    {
        q: "Pentadbiran X telah ditubuhkan di Tanah Melayu bagi menggantikan Malayan Union 1946. Apakah Pentadbiran X?",
        options: ["British Military Administration", "Persekutuan Tanah Melayu", "Pentadbiran Tentera British", "Malayan Democratic Union"],
        answer: "Persekutuan Tanah Melayu",
        explain: "Persekutuan Tanah Melayu 1948 ditubuhkan untuk menggantikan Malayan Union 1946 yang ditolak oleh penduduk tempatan.",
        encourage: "正确！你明白了政治制度的演变过程。历史的连续性很重要！"
    },
    {
        q: "Kumpulan yang menolak perjanjian persekutuan kerana Jawatankuasa Kerja tidak mempunyai wakil bukan Melayu dan menganggap ia tidak demokratik ialah:",
        options: ["UMNO", "MCA", "PUTERA-AMCJA", "API"],
        answer: "PUTERA-AMCJA",
        explain: "PUTERA-AMCJA menolak Perjanjian Persekutuan 1948 kerana menganggap Jawatankuasa Kerja tidak demokratik dan tidak mempunyai wakil bukan Melayu.",
        encourage: "出色！你理解了不同政治集团的立场。多元观点的理解很重要！"
    },
    {
        q: "Mengapakah pihak British menyokong penubuhan Persekutuan Tanah Melayu 1948?",
        options: ["Menjamin kestabilan politik", "Mengatasi ancaman ekonomi", "Mengurangkan beban kewangan", "Mengurangkan kuasa raja-raja Melayu"],
        answer: "Menjamin kestabilan politik",
        explain: "British menyokong konsep persekutuan kerana dapat mewujudkan keamanan, kestabilan dan kemajuan ekonomi di Tanah Melayu.",
        encourage: "很好！你理解了英国支持PTM的动机。政治稳定确实很重要！"
    },
    {
        q: "Berdasarkan Persekutuan Tanah Melayu 1948, jus soli hanya diberikan kepada: I. Rakyat Asing II. Rakyat Raja III. Rakyat British IV. Rakyat Pribumi",
        options: ["I dan II", "I dan IV", "II dan III", "III dan IV"],
        answer: "II dan III",
        explain: "Dalam PTM 1948, jus soli hanya terbuka kepada rakyat Raja dan rakyat British sahaja, bukan kepada semua penduduk.",
        encourage: "正确！你掌握了PTM 1948中公民权的重要特征。这是重大的政治变化！"
    },
    {
        q: "Siapakah yang mengetuai pentadbiran Kerajaan Persekutuan 1948?",
        options: ["Gabenor Jeneral", "Residen Jeneral", "Residen Konsular", "Pesuruhjaya Tinggi"],
        answer: "Pesuruhjaya Tinggi",
        explain: "Kerajaan Persekutuan diketuai oleh seorang Pesuruhjaya Tinggi British, bukan lagi Gabenor seperti dalam Malayan Union.",
        encourage: "很好！你注意到了行政首长职位的变化。这个细节很重要！"
    },
    {
        q: "Apakah tanggungjawab sultan di peringkat negeri dalam Persekutuan Tanah Melayu 1948?",
        options: ["Menjalankan kuasa eksekutif", "Menjaga ketenteraman awam", "Mengesahkan rang undang-undang", "Menganggotai Majlis Mesyuarat Negeri"],
        answer: "Mengesahkan rang undang-undang",
        explain: "Bagi peringkat negeri, sultan bertanggungjawab mengesahkan rang undang-undang yang diluluskan dalam Dewan Perundangan Negeri.",
        encourage: "出色！你理解了苏丹在州级政府中的具体职责。权力分配很清楚！"
    },
    {
        q: "Persekutuan Tanah Melayu 1948 telah membentuk sebuah Majlis Raja-Raja. Apakah kuasa majlis tersebut?",
        options: ["Memberikan pandangan dalam perkara tertentu", "Mengesahkan keputusan Pesuruhjaya Tinggi", "Mengetuai Majlis Perundangan Persekutuan", "Meluluskan semua pindaan perlembagaan"],
        answer: "Memberikan pandangan dalam perkara tertentu",
        explain: "Majlis Raja-Raja dibentuk untuk membolehkan Raja-raja Melayu memberikan pandangan dalam perkara yang tertentu.",
        encourage: "非常好！你明白了统治者理事会的咨询性质。这是重要的制衡机制！"
    },
    {
        q: "Mengapakah orang Melayu tidak menentang penubuhan Persekutuan Tanah Melayu yang ditubuhkan pada 1948?",
        options: ["Undang-undang tradisional tamat", "Kuasa Raja-raja Melayu dikembalikan", "Singapura dipisahkan daripada persekutuan", "Kaum imigran tidak diberikan taraf warganegara"],
        answer: "Kuasa Raja-raja Melayu dikembalikan",
        explain: "Orang Melayu menerima PTM 1948 kerana ia mengembalikan kedudukan dan kedaulatan Raja-raja Melayu seperti sebelum perang.",
        encourage: "很好！你理解了马来人接受PTM的关键原因。主权恢复很重要！"
    },
    {
        q: "Pada 1 Februari 1948, Persekutuan Tanah Melayu telah ditubuhkan secara rasmi. Apakah implikasi penubuhannya? I. Merangka sistem pendidikan yang seragam II. Mengadakan rundingan ke arah kemerdekaan III. Mengiktiraf kedudukan istimewa orang Melayu IV. Membuka jalan ke arah perpaduan kaum",
        options: ["I dan II", "I dan IV", "II dan III", "III dan IV"],
        answer: "III dan IV",
        explain: "PTM 1948 mengiktiraf kedudukan istimewa orang Melayu dan membuka jalan ke arah perpaduan serta kerjasama antara kaum.",
        encourage: "太棒了！你掌握了PTM 1948的长远影响。社会和谐很重要！"
    },
    {
        q: "Antara berikut, yang manakah berkaitan dengan isi Perjanjian Persekutuan Tanah Melayu 1948? I. Hak semua kaum terjamin II. Majlis Raja-Raja dibentuk III. Pembentukan sebuah persekutuan IV. Mengiktiraf kedudukan agama Islam",
        options: ["I dan II", "I dan IV", "II dan III", "III dan IV"],
        answer: "II dan III",
        explain: "Perjanjian PTM 1948 memperuntukkan pembentukan Majlis Raja-Raja dan pembentukan sebuah persekutuan yang menggantikan Malayan Union.",
        encourage: "出色！你能识别条约的具体内容。法律文件的理解很好！"
    },
    {
        q: "Apakah faktor yang menyebabkan British menggantikan Malayan Union dengan Persekutuan Tanah Melayu 1948? I. Ketidakpuasan hati terhadap British II. Cadangan Raja-raja Melayu dan UMNO III. Penentangan orang Melayu terhadap Malayan Union IV. Kegagalan British mentadbir Malayan Union",
        options: ["I dan II", "I dan IV", "II dan III", "III dan IV"],
        answer: "II dan III",
        explain: "Faktor utama penubuhan PTM 1948 adalah penentangan orang Melayu terhadap Malayan Union dan cadangan Raja-raja Melayu serta UMNO untuk alternatif yang lebih sesuai.",
        encourage: "非常好！你掌握了PTM 1948成立的主要推动因素！"
    },
    {
        q: "Apakah ciri-ciri utama Perjanjian Persekutuan Tanah Melayu 1948? I. Kerakyatan sama rata bagi semua II. Singapura disatukan dengan Tanah Melayu III. Kedudukan istimewa orang Melayu dilindungi IV. Pembentukan Senarai Persekutuan dan Senarai Negeri",
        options: ["I dan II", "I dan IV", "II dan III", "III dan IV"],
        answer: "III dan IV",
        explain: "Ciri utama PTM 1948 termasuk melindungi kedudukan istimewa orang Melayu dan pembentukan senarai kuasa persekutuan dan negeri.",
        encourage: "太棒了！你能识别PTM 1948的关键特征。制度设计的理解很好！"
    },
    {
        q: "Kewarganegaraan Persekutuan Tanah Melayu (PTM) 1948 boleh diperoleh melalui 'kuatkuasa undang-undang' untuk golongan:",
        options: ["Semua penduduk Tanah Melayu", "Rakyat Raja dan Rakyat British sahaja", "Semua kaum bukan Melayu", "Penduduk yang telah naturalisasi"],
        answer: "Rakyat Raja dan Rakyat British sahaja",
        explain: "Kewarganegaraan secara kuat kuasa undang-undang diberikan kepada rakyat Raja dan rakyat British berdasarkan jus soli yang ditetapkan dalam PTM 1948.",
        encourage: "非常优秀！你掌握了公民权获得的重要限制。这是PTM的关键特征！"
    },
    {
        q: "Persekutuan Tanah Melayu 1948 telah mewujudkan kerjasama antara kaum melalui penubuhan:",
        options: ["Majlis Raja-Raja", "Communities Liaison Committee (CLC)", "Dewan Perundangan Persekutuan", "Jawatankuasa Hubungan Kaum"],
        answer: "Communities Liaison Committee (CLC)",
        explain: "PTM 1948 membuka jalan ke arah perpaduan dan kerjasama antara kaum melalui penubuhan Jawatankuasa Hubungan Antara Kaum atau Communities Liaison Committee (CLC).",
        encourage: "优秀！你理解了PTM在促进种族和谐方面的努力。社会团结很重要！"
    }
];

function showTab(tabId) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Deactivate all tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabId).classList.add('active');
    
    // Activate selected tab
    event.currentTarget.classList.add('active');
    
    // If history tab is selected, load history
    if (tabId === 'history') {
        loadHistory();
    }
}

function submitQuiz() {
    const name = document.getElementById('name').value;
    const form = document.getElementById('form').value;
    
    if (!name || !form) {
        alert("请填写完整的个人信息！");
        return;
    }
    
    let score = 0;
    let results = [];
    let unanswered = 0;
    
    questions.forEach((q, index) => {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        const isCorrect = selected && selected.value === q.answer;
        
        if (isCorrect) score++;
        if (!selected) unanswered++;
        
        results.push({
            question: q.q,
            selected: selected ? selected.value : "未作答",
            correct: q.answer,
            isCorrect: isCorrect,
            explain: q.explain,
            encourage: q.encourage
        });
    });
    
    // Save the attempt to history
    saveAttempt(name, form, score, results);
    
    // Display results
    displayResults(name, form, score, results, unanswered);
}

function displayResults(name, form, score, results, unanswered) {
    let output = `
        <h3>名字: ${name}</h3>
        <h3>年级: ${form}</h3>
        <h3>得分: <span class="${score >= 16 ? 'correct' : 'incorrect'}">${score} / 20</span></h3>
        ${unanswered > 0 ? `<p>注意：你有 ${unanswered} 题没有作答</p>` : ''}
        <p>${getFeedback(score)}</p>
        <div class="save-buttons">
            <button class="download-btn" onclick="generateReportImage('${name}', '${form}', ${score}, ${unanswered})">🖼️ 生成成绩单图片</button>
        </div>
        <div id="reportCanvas" style="margin-top: 20px;"></div>
        <hr>
    `;
    
    results.forEach((r, index) => {
        output += `
            <div class="question">
                <p><strong>第${index + 1}题：${r.isCorrect ? '正确 ✅' : '错误 ❌'}</strong></p>
                <p>题目: ${r.question}</p>
                ${!r.isCorrect ? `<p>你的答案: <span class="incorrect">${r.selected}</span></p>` : ''}
                <p>正确答案: <span class="correct">${r.correct}</span></p>
                <p>解释: ${r.explain}</p>
                <p>鼓励: ${r.encourage}</p>
            </div>
        `;
    });
    
    document.getElementById('result').innerHTML = output;
    document.getElementById('result').classList.remove('hidden');
    
    // Scroll to results
    document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
}

function getFeedback(score) {
    if (score === 20) {
        return "太厉害啦！全对耶！你对Persekutuan Tanah Melayu 1948的掌握非常完美！🎉 历史学霸就是你！";
    } else if (score >= 18) {
        return "成绩优异！你对PTM 1948的理解很深入，只有少许细节需要注意！✨ 继续保持！";
    } else if (score >= 15) {
        return "很不错！基本概念都掌握了，对历史发展脉络理解得很好！😊 加油！";
    } else if (score >= 12) {
        return "有进步空间！建议多复习工作委员会和政治制度的内容，你会更棒的！💪";
    } else if (score >= 8) {
        return "需要加强复习哦！重点关注PTM 1948的成立背景和重要特征！📚";
    } else {
        return "建议重新学习这个章节，多看课本和笔记，历史需要慢慢积累的！🌱 不要放弃！";
    }
}

// 日期格式化函数：DD/MM/YYYY
function formatDate(date) {
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

function generateReportImage(name, form, score, unanswered) {
    // Get current quiz results for error analysis
    let wrongAnswers = [];
    questions.forEach((q, index) => {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        const isCorrect = selected && selected.value === q.answer;
        if (!isCorrect) {
            wrongAnswers.push({
                number: index + 1,
                question: q.q.substring(0, 50) + "...",
                selected: selected ? selected.value : "未作答",
                correct: q.answer
            });
        }
    });

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Calculate canvas height based on number of wrong answers
    const baseHeight = 800;
    const errorHeight = wrongAnswers.length * 30 + 100; // 30px per error + some padding
    canvas.width = 800;
    canvas.height = Math.max(baseHeight, baseHeight + errorHeight);
    
    // Background gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#f8f9fa');
    gradient.addColorStop(1, '#e9ecef');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Header background
    ctx.fillStyle = '#2c3e50';
    ctx.fillRect(0, 0, canvas.width, 120);
    
    // Title
    ctx.fillStyle = 'white';
    ctx.font = 'bold 28px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('F4 Sejarah Bab 5 Quiz', canvas.width/2, 45);
    ctx.font = 'bold 24px Arial';
    ctx.fillText('Persekutuan Tanah Melayu 1948', canvas.width/2, 75);
    ctx.font = '18px Arial';
    ctx.fillText('马来亚联邦1948年成绩单', canvas.width/2, 100);
    
    // Student Info Section
    ctx.fillStyle = '#333';
    ctx.font = 'bold 24px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('学生信息 Student Information', 50, 170);
    
    ctx.font = '20px Arial';
    ctx.fillText(`姓名 Name: ${name}`, 50, 210);
    ctx.fillText(`年级 Form: ${form}`, 50, 240);
    ctx.fillText(`测验日期 Date: ${formatDate(new Date())}`, 50, 270);
    
    // Score Section
    const percentage = Math.round((score / 20) * 100);
    
    ctx.fillStyle = '#2196F3';
    ctx.font = 'bold 24px Arial';
    ctx.fillText('测验成绩 Test Results', 50, 320);
    
    // Score circle
    const centerX = canvas.width - 150;
    const centerY = 370;
    const radius = 80;
    
    // Draw score circle background
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.fillStyle = score >= 16 ? '#4CAF50' : score >= 12 ? '#FF9800' : '#F44336';
    ctx.fill();
    
    // Score text in circle
    ctx.fillStyle = 'white';
    ctx.font = 'bold 36px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`${score}/20`, centerX, centerY - 10);
    ctx.font = 'bold 20px Arial';
    ctx.fillText(`${percentage}%`, centerX, centerY + 20);
    
    // Detailed scores
    ctx.fillStyle = '#333';
    ctx.font = '20px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(`总分 Total Score: ${score}/20 (${percentage}%)`, 50, 360);
    
    if (unanswered > 0) {
        ctx.fillStyle = '#F44336';
        ctx.fillText(`未作答题目 Unanswered: ${unanswered} 题`, 50, 390);
    }
    
    // Performance Analysis
    ctx.fillStyle = '#333';
    ctx.font = 'bold 24px Arial';
    let currentY = unanswered > 0 ? 450 : 420;
    ctx.fillText('表现分析 Performance Analysis', 50, currentY);
    
    ctx.font = '18px Arial';
    const feedback = getFeedback(score);
    const words = feedback.split(' ');
    let line = '';
    currentY += 30;
    
    for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        const testWidth = metrics.width;
        if (testWidth > 700 && n > 0) {
            ctx.fillText(line, 50, currentY);
            line = words[n] + ' ';
            currentY += 25;
        } else {
            line = testLine;
        }
    }
    ctx.fillText(line, 50, currentY);
    
    // Wrong Answers Section (show ALL wrong answers)
    if (wrongAnswers.length > 0) {
        currentY += 50;
        ctx.fillStyle = '#F44336';
        ctx.font = 'bold 20px Arial';
        ctx.fillText(`错题分析 Wrong Answers (${wrongAnswers.length} 题)`, 50, currentY);
        
        ctx.fillStyle = '#333';
        ctx.font = '16px Arial';
        
        // Show ALL wrong answers
        wrongAnswers.forEach((error, index) => {
            currentY += 30;
            ctx.fillText(`${index + 1}. 第${error.number}题: ${error.selected} → ${error.correct}`, 50, currentY);
        });
    }
    
    // Footer
    ctx.fillStyle = '#666';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('继续加油，学好马来亚历史！Keep studying Malaysian History!', canvas.width/2, canvas.height - 30);
    
    // Display canvas and download options
    const reportDiv = document.getElementById('reportCanvas');
    reportDiv.innerHTML = `
        <div class="canvas-container">
            <h3>📋 成绩单已生成</h3>
            <canvas id="generatedCanvas" width="800" height="${canvas.height}" style="max-width: 100%; height: auto; border: 1px solid #ddd;"></canvas>
            <div style="margin-top: 15px;">
                <button class="download-btn" onclick="downloadReportImage()">💾 下载图片</button>
                <button class="save-btn" onclick="shareReportImage()">📤 分享图片</button>
            </div>
            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                💡 提示：点击"下载图片"保存到设备，或点击"分享图片"通过其他应用分享
            </p>
        </div>
    `;
    
    // Copy canvas content to displayed canvas
    const displayCanvas = document.getElementById('generatedCanvas');
    displayCanvas.height = canvas.height;
    const displayCtx = displayCanvas.getContext('2d');
    displayCtx.drawImage(canvas, 0, 0);
    
    // Store canvas globally for download
    window.reportCanvas = canvas;
    
    // Scroll to canvas
    reportDiv.scrollIntoView({ behavior: 'smooth' });
}

function downloadReportImage() {
    if (window.reportCanvas) {
        const today = new Date();
        const dateStr = formatDate(today).replace(/\//g, '-'); // 替换/为-用于文件名
        const link = document.createElement('a');
        link.download = `F4_Sejarah_Bab5_成绩单_${dateStr}.png`;
        link.href = window.reportCanvas.toDataURL();
        link.click();
    }
}

function shareReportImage() {
    if (navigator.share && window.reportCanvas) {
        // Convert canvas to blob
        window.reportCanvas.toBlob(function(blob) {
            const file = new File([blob], 'F4_Sejarah_Bab5_成绩单.png', { type: 'image/png' });
            navigator.share({
                title: 'F4 Sejarah Bab 5 Quiz 成绩单',
                text: '我的马来亚历史测验成绩单',
                files: [file]
            }).catch(err => {
                console.log('分享失败:', err);
                // Fallback to download
                downloadReportImage();
            });
        });
    } else {
        // Fallback: just download the image
        downloadReportImage();
        alert('成绩单图片已下载到您的设备 📱');
    }
}

function getGrade(score) {
    if (score >= 19) return "A+ 优秀";
    if (score >= 17) return "A 良好";  
    if (score >= 15) return "B+ 不错";
    if (score >= 13) return "B 及格";
    if (score >= 10) return "C+ 需要努力";
    if (score >= 8) return "C 需要加强";
    return "D 需要重新学习";
}

function getSkillLevel(score) {
    if (score >= 18) return "历史专家级 🌟";
    if (score >= 15) return "历史熟练级 ⭐";
    if (score >= 12) return "历史中级 📚";
    if (score >= 8) return "历史初级 📖";
    return "历史入门级 🔰";
}

function saveAttempt(name, form, score, results) {
    const attempts = JSON.parse(localStorage.getItem('sejarahBab5QuizAttempts') || '[]');
    const attempt = {
        date: new Date().toLocaleString(),
        name,
        form,
        score,
        results
    };
    
    attempts.unshift(attempt); // Add new attempt at beginning
    localStorage.setItem('sejarahBab5QuizAttempts', JSON.stringify(attempts));
}

function loadHistory() {
    const attempts = JSON.parse(localStorage.getItem('sejarahBab5QuizAttempts') || '[]');
    const historyList = document.getElementById('historyList');
    
    if (attempts.length === 0) {
        historyList.innerHTML = "<p>你还没有任何测验记录，快去做测验吧！</p>";
        return;
    }
    
    let html = "";
    attempts.forEach((attempt, index) => {
        html += `
            <div class="question" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px;">
                <h3>测验 #${index + 1} - ${attempt.date}</h3>
                <p>姓名: ${attempt.name} | 年级: ${attempt.form}</p>
                <p>得分: <strong>${attempt.score} / 20</strong></p>
                <button onclick="viewAttemptDetails(${index})">查看详情</button>
                <div style="margin-top: 10px;">
                    <button class="download-btn" onclick="generateHistoryReportImage(${index})" style="font-size: 12px; padding: 8px 12px;">🖼️ 生成成绩单图片</button>
                </div>
                <div id="attemptDetails${index}" style="display: none; margin-top: 10px;">
                    ${attempt.results.map((r, qIndex) => `
                        <div style="margin-bottom: 15px; padding: 10px; background: ${r.isCorrect ? '#e6ffe6' : '#ffe6e6'}; border-radius: 5px;">
                            <p><strong>第${qIndex + 1}题：${r.isCorrect ? '正确 ✅' : '错误 ❌'}</strong></p>
                            <p>题目: ${r.question}</p>
                            ${!r.isCorrect ? `<p>你的答案: ${r.selected}</p>` : ''}
                            <p>正确答案: ${r.correct}</p>
                            <p>解释: ${r.explain}</p>
                            <p>鼓励: ${r.encourage}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    historyList.innerHTML = html;
}

function generateHistoryReportImage(attemptIndex) {
    const attempts = JSON.parse(localStorage.getItem('sejarahBab5QuizAttempts') || '[]');
    const attempt = attempts[attemptIndex];
    
    if (!attempt) {
        alert("找不到该测验记录！");
        return;
    }
    
    const unanswered = attempt.results.filter(r => r.selected === "未作答").length;
    const wrongAnswers = attempt.results.filter(r => !r.isCorrect).map((r, index) => ({
        number: attempt.results.indexOf(r) + 1,
        question: r.question.substring(0, 50) + "...",
        selected: r.selected,
        correct: r.correct
    }));

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Calculate canvas height based on number of wrong answers
    const baseHeight = 800;
    const errorHeight = wrongAnswers.length * 30 + 100;
    canvas.width = 800;
    canvas.height = Math.max(baseHeight, baseHeight + errorHeight);
    
    // Background gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#f8f9fa');
    gradient.addColorStop(1, '#e9ecef');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Header background
    ctx.fillStyle = '#2c3e50';
    ctx.fillRect(0, 0, canvas.width, 120);
    
    // Title
    ctx.fillStyle = 'white';
    ctx.font = 'bold 28px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('F4 Sejarah Bab 5 Quiz', canvas.width/2, 45);
    ctx.font = 'bold 24px Arial';
    ctx.fillText('Persekutuan Tanah Melayu 1948', canvas.width/2, 75);
    ctx.font = '18px Arial';
    ctx.fillText('马来亚联邦1948年成绩单', canvas.width/2, 100);
    
    // Student Info Section
    ctx.fillStyle = '#333';
    ctx.font = 'bold 24px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('学生信息 Student Information', 50, 170);
    
    // 格式化历史记录中的日期
    let formattedDate;
    try {
        const attemptDate = new Date(attempt.date);
        formattedDate = formatDate(attemptDate);
    } catch (error) {
        formattedDate = attempt.date; // 如果解析失败，使用原日期
    }
    
    ctx.font = '20px Arial';
    ctx.fillText(`姓名 Name: ${attempt.name}`, 50, 210);
    ctx.fillText(`年级 Form: ${attempt.form}`, 50, 240);
    ctx.fillText(`测验日期 Date: ${formattedDate}`, 50, 270);
    
    // Score Section
    const percentage = Math.round((attempt.score / 20) * 100);
    
    ctx.fillStyle = '#2196F3';
    ctx.font = 'bold 24px Arial';
    ctx.fillText('测验成绩 Test Results', 50, 320);
    
    // Score circle
    const centerX = canvas.width - 150;
    const centerY = 370;
    const radius = 80;
    
    // Draw score circle background
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.fillStyle = attempt.score >= 16 ? '#4CAF50' : attempt.score >= 12 ? '#FF9800' : '#F44336';
    ctx.fill();
    
    // Score text in circle
    ctx.fillStyle = 'white';
    ctx.font = 'bold 36px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`${attempt.score}/20`, centerX, centerY - 10);
    ctx.font = 'bold 20px Arial';
    ctx.fillText(`${percentage}%`, centerX, centerY + 20);
    
    // Detailed scores
    ctx.fillStyle = '#333';
    ctx.font = '20px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(`总分 Total Score: ${attempt.score}/20 (${percentage}%)`, 50, 360);
    
    if (unanswered > 0) {
        ctx.fillStyle = '#F44336';
        ctx.fillText(`未作答题目 Unanswered: ${unanswered} 题`, 50, 390);
    }
    
    // Performance Analysis
    ctx.fillStyle = '#333';
    ctx.font = 'bold 24px Arial';
    let currentY = unanswered > 0 ? 450 : 420;
    ctx.fillText('表现分析 Performance Analysis', 50, currentY);
    
    ctx.font = '18px Arial';
    const feedback = getFeedback(attempt.score);
    const words = feedback.split(' ');
    let line = '';
    currentY += 30;
    
    for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        const testWidth = metrics.width;
        if (testWidth > 700 && n > 0) {
            ctx.fillText(line, 50, currentY);
            line = words[n] + ' ';
            currentY += 25;
        } else {
            line = testLine;
        }
    }
    ctx.fillText(line, 50, currentY);
    
    // Wrong Answers Section
    if (wrongAnswers.length > 0) {
        currentY += 50;
        ctx.fillStyle = '#F44336';
        ctx.font = 'bold 20px Arial';
        ctx.fillText(`错题分析 Wrong Answers (${wrongAnswers.length} 题)`, 50, currentY);
        
        ctx.fillStyle = '#333';
        ctx.font = '16px Arial';
        
        wrongAnswers.forEach((error, index) => {
            currentY += 30;
            ctx.fillText(`${index + 1}. 第${error.number}题: ${error.selected} → ${error.correct}`, 50, currentY);
        });
    }
    
    // Footer
    ctx.fillStyle = '#666';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('继续加油，学好马来亚历史！Keep studying Malaysian History!', canvas.width/2, canvas.height - 30);
    
    // Create download link
    let downloadDateStr;
    try {
        const attemptDate = new Date(attempt.date);
        downloadDateStr = formatDate(attemptDate).replace(/\//g, '-');
    } catch (error) {
        downloadDateStr = attempt.date.replace(/[/:]/g, '-');
    }
    
    const link = document.createElement('a');
    link.download = `F4_Sejarah_Bab5_成绩单_${attempt.name}_${downloadDateStr}.png`;
    link.href = canvas.toDataURL();
    link.click();
    
    // Also show success message
    alert('成绩单图片已下载！您可以保存或通过其他方式分享 📱');
}

function viewAttemptDetails(index) {
    const detailsDiv = document.getElementById(`attemptDetails${index}`);
    if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
    } else {
        detailsDiv.style.display = 'none';
    }
}

function saveProgress() {
    const name = document.getElementById('name').value;
    const form = document.getElementById('form').value;
    
    if (!name || !form) {
        alert("请先填写个人信息！");
        return;
    }
    
    const progress = {
        name,
        form,
        answers: []
    };
    
    questions.forEach((q, index) => {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        progress.answers.push(selected ? selected.value : null);
    });
    
    localStorage.setItem('sejarahBab5QuizProgress', JSON.stringify(progress));
    alert("进度已保存！你可以稍后回来继续完成测验。");
}

function loadProgress() {
    const progress = JSON.parse(localStorage.getItem('sejarahBab5QuizProgress'));
    
    if (!progress) {
        alert("没有找到保存的进度！");
        return;
    }
    
    document.getElementById('name').value = progress.name;
    document.getElementById('form').value = progress.form;
    
    progress.answers.forEach((answer, index) => {
        if (answer) {
            const radio = document.querySelector(`input[name="q${index}"][value="${answer}"]`);
            if (radio) {
                radio.checked = true;
                // 添加视觉选中效果
                const label = radio.closest('label');
                if (label) {
                    label.classList.add('selected');
                }
            }
        }
    });
    
    alert("进度已加载！你可以继续完成测验。");
}

window.onload = function() {
    const qDiv = document.getElementById('questions');
    questions.forEach((q, index) => {
        const div = document.createElement('div');
        div.className = "question";
        div.innerHTML = `<p><strong>第${index + 1}题.</strong> ${q.q}</p>` +
                        q.options.map((opt, optIndex) => `
                            <label onclick="selectOption(this, ${index}, ${optIndex})">
                                <input type="radio" name="q${index}" value="${opt}">
                                <span>${opt}</span>
                            </label>
                        `).join('');
        qDiv.appendChild(div);
        
        // 添加radio button change事件监听器
        div.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    // 清除同一题目其他选项的selected样式
                    const questionDiv = this.closest('.question');
                    const allLabels = questionDiv.querySelectorAll('label');
                    allLabels.forEach(label => label.classList.remove('selected'));
                    
                    // 给当前选择的选项添加selected样式
                    const currentLabel = this.closest('label');
                    if (currentLabel) {
                        currentLabel.classList.add('selected');
                    }
                }
            });
        });
    });
    
    // Check if there's saved progress
    if (localStorage.getItem('sejarahBab5QuizProgress')) {
        if (confirm("检测到有保存的进度，是否加载？")) {
            loadProgress();
        }
    }
}

// 添加选项选择函数，提供更好的视觉反馈
function selectOption(labelElement, questionIndex, optionIndex) {
    // 清除同一题目的其他选项的selected样式
    const questionDiv = labelElement.closest('.question');
    const allLabels = questionDiv.querySelectorAll('label');
    allLabels.forEach(label => label.classList.remove('selected'));
    
    // 给当前选择的选项添加selected样式
    labelElement.classList.add('selected');
    
    // 确保radio button被选中
    const radioButton = labelElement.querySelector('input[type="radio"]');
    radioButton.checked = true;
    
    // 设置正确的value值
    radioButton.value = questions[questionIndex].options[optionIndex];
}
</script>

</body>
</html>
