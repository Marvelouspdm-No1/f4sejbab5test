<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <title>F4 Sejarah Bab 5 Quiz</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f2f2f2;
            max-width: 800px;
            margin: 0 auto;
        }
        .question {
            background: #fff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .result {
            background: #e6ffe6;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .history {
            background: #e6f3ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .hidden {
            display: none;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #ddd;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .correct {
            color: green;
        }
        .incorrect {
            color: red;
        }
        .save-buttons {
            margin-top: 20px;
            text-align: center;
        }
        .save-btn {
            background-color: #2196F3;
            margin: 5px;
        }
        .save-btn:hover {
            background-color: #0b7dda;
        }
        .whatsapp-btn {
            background-color: #25D366;
            margin: 5px;
        }
        .whatsapp-btn:hover {
            background-color: #1da851;
        }
        .download-btn {
            background-color: #FF6B35;
            margin: 5px;
        }
        .download-btn:hover {
            background-color: #E55A2B;
        }
        #reportCanvas {
            text-align: center;
        }
        .canvas-container {
            display: inline-block;
            margin: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        label {
            display: block;
            margin: 5px 0;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
        }
        label:hover {
            background-color: #f0f0f0;
        }
        input[type="radio"] {
            margin-right: 8px;
        }
        .info-box {
            background: #e6f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>

<h2>F4 Sejarah Bab 5 Quiz - Persekutuan Tanah Melayu 1948</h2>
<div class="info-box">
    <p><strong>ğŸ’¡ æ¸©é¦¨æç¤ºï¼š</strong></p>
    <p>â€¢ ğŸ“± <strong>å‘é€æˆç»©ç»™è€å¸ˆ</strong> - ç›´æ¥å‘é€åˆ°è€å¸ˆWhatsApp (+60127317286)</p>
    <p>â€¢ ğŸ–¼ï¸ <strong>ç”Ÿæˆæˆç»©å•å›¾ç‰‡</strong> - åˆ¶ä½œæ­£å¼çš„æˆç»©å•å›¾ç‰‡ï¼Œå¯ä¸‹è½½åå‘é€ç»™è€å¸ˆ</p>
    <p>â€¢ ğŸ’¾ å›¾ç‰‡æ ¼å¼çš„æˆç»©å•æ›´æ­£å¼ï¼ŒåŒ…å«è¯¦ç»†çš„é”™é¢˜åˆ†æï¼Œé€‚åˆå‘è€å¸ˆæ±‡æŠ¥</p>
    <p>â€¢ ğŸ“š æœ¬æµ‹éªŒæ¶µç›–Persekutuan Tanah Melayu 1948çš„é‡è¦çŸ¥è¯†ç‚¹</p>
</div>

<div class="tabs">
    <div class="tab active" onclick="showTab('quiz')">åšæµ‹éªŒ</div>
    <div class="tab" onclick="showTab('history')">æŸ¥çœ‹è®°å½•</div>
</div>

<div id="quiz" class="tab-content active">
    <form id="quizForm">
        <label>Name (åå­—):</label><br>
        <input type="text" id="name" required><br><br>

        <label>Form (å¹´çº§):</label><br>
        <select id="form" required>
            <option value="">Select</option>
            <option value="F1">F1</option>
            <option value="F2">F2</option>
            <option value="F3">F3</option>
            <option value="F4">F4</option>
            <option value="F5">F5</option>
        </select><br><br>

        <div id="questions"></div>

        <button type="button" onclick="submitQuiz()">æäº¤ç­”æ¡ˆ</button>
        <button type="button" onclick="saveProgress()">ä¿å­˜è¿›åº¦</button>
        <button type="button" onclick="loadProgress()">åŠ è½½è¿›åº¦</button>
    </form>

    <div id="result" class="result hidden"></div>
</div>

<div id="history" class="tab-content">
    <h3>ä½ çš„æµ‹éªŒè®°å½•</h3>
    <div id="historyList"></div>
</div>

<script>
const questions = [
    {
        q: "Persekutuan Tanah Melayu diperkenalkan bagi menggantikan Malayan Union 1946 yang ditolak oleh siapakah?",
        options: ["Rakyat tempatan", "Golongan radikal", "Pentadbir British", "Pemimpin parti"],
        answer: "Rakyat tempatan",
        explain: "Persekutuan Tanah Melayu 1948 diperkenalkan untuk menggantikan Malayan Union 1946 yang ditolak oleh penduduk tempatan, terutamanya orang Melayu yang tidak bersetuju dengan syarat-syarat dalam Malayan Union.",
        encourage: "å¾ˆå¥½ï¼ä½ æŒæ¡äº†PTM 1948æˆç«‹çš„åŸºæœ¬èƒŒæ™¯ã€‚ç»§ç»­ä¿æŒè¿™ç§å­¦ä¹ æ€åŠ¿ï¼"
    },
    {
        q: "Siapakah yang menjadi wakil Raja-Raja Melayu dalam penubuhan Jawatankuasa Kerja pada tahun 1946?",
        options: ["Dato Onn Jaafar", "Haji Megat Yunus", "Tunku Abdul Rahman", "Dato'Nik Ahmed Kamil Mahmud"],
        answer: "Dato'Nik Ahmed Kamil Mahmud",
        explain: "Dato'Nik Ahmad Kamil Mahmud - Dato'Seri Setia Raja Kelantan adalah salah seorang wakil Raja-raja Melayu dalam Jawatankuasa Kerja, bersama dengan Raja Kamaralzaman Raja Ngah Mansur, Dato' Hamzah Abdullah, dan Haji Mohanad Sheriff Osman.",
        encourage: "å‡ºè‰²ï¼ä½ èƒ½å‡†ç¡®è¯†åˆ«å·¥ä½œå§”å‘˜ä¼šä¸­çš„é©¬æ¥ç»Ÿæ²»è€…ä»£è¡¨ã€‚å†å²äººç‰©çš„æŒæ¡å¾ˆé‡è¦ï¼"
    },
    {
        q: "Mengapakah British menubuhkan Jawatankuasa Kerja pada 25 Julai 1946?",
        options: ["Memeriksa Perlembagaan Rakyat", "Menilai pelaksanaan Malayan Union", "Memperkenalkan Dasar Pendidikan Kebangsaan", "Merangka Perjanjian Persekutuan Tanah Melayu"],
        answer: "Merangka Perjanjian Persekutuan Tanah Melayu",
        explain: "Jawatankuasa Kerja ditubuhkan khusus untuk membincangkan asas dan merangka Perjanjian Persekutuan Tanah Melayu 1948 sebagai pengganti kepada Malayan Union.",
        encourage: "å¤ªæ£’äº†ï¼ä½ ç†è§£äº†å·¥ä½œå§”å‘˜ä¼šçš„ä¸»è¦ç›®çš„ã€‚æ”¿æ²»å‘å±•çš„è„‰ç»œå¾ˆé‡è¦ï¼"
    },
    {
        q: "Antara berikut, tokoh manakah merupakan wakil Raja-raja Melayu dalam Jawatankuasa Kerja? I. Haji Megat Yunus II. Dato Hamzah Abdullah III. Haji Mohamad Sheriff Osman IV. Dato Abdul Rahman Mohd Yassin",
        options: ["I dan II", "I dan IV", "II dan III", "III dan IV"],
        answer: "II dan III",
        explain: "Dato Hamzah Abdullah (Orang Kaya Menteri Besar Selangor) dan Haji Mohamad Sheriff Osman (Setiausaha Kerajaan Kedah) adalah wakil Raja-raja Melayu dalam Jawatankuasa Kerja.",
        encourage: "éå¸¸å¥½ï¼ä½ èƒ½åŒºåˆ†ä¸åŒç±»åˆ«çš„ä»£è¡¨ã€‚ç»†èŠ‚æŒæ¡å¾—å¾ˆå¥½ï¼"
    },
    {
        q: "Jawatankuasa Kerja dibentuk untuk merangka Perjanjian Persekutuan Tanah Melayu 1948. Apakah cadangan yang disediakan oleh Jawatankuasa tersebut? I. Menjaga kedudukan istimewa orang Melayu II. Memulihkan kedudukan Raja-raja Melayu III. Menyatukan Tanah Melayu dengan Singapura IV. Membentuk sebuah kerajaan pusat yang kuat",
        options: ["I dan II", "I dan IV", "II dan III", "III dan IV"],
        answer: "I dan II",
        explain: "Jawatankuasa Kerja mencadangkan untuk menjaga kedudukan istimewa orang Melayu dan memulihkan kedudukan serta kedaulatan Raja-raja Melayu.",
        encourage: "ä¼˜ç§€ï¼ä½ æŒæ¡äº†å·¥ä½œå§”å‘˜ä¼šçš„ä¸»è¦å»ºè®®ã€‚è¿™äº›éƒ½æ˜¯PTM 1948çš„æ ¸å¿ƒç‰¹å¾ï¼"
    },
    {
        q: "Pentadbiran X telah ditubuhkan di Tanah Melayu bagi menggantikan Malayan Union 1946. Apakah Pentadbiran X?",
        options: ["British Military Administration", "Persekutuan Tanah Melayu", "Pentadbiran Tentera British", "Malayan Democratic Union"],
        answer: "Persekutuan Tanah Melayu",
        explain: "Persekutuan Tanah Melayu 1948 ditubuhkan untuk menggantikan Malayan Union 1946 yang ditolak oleh penduduk tempatan.",
        encourage: "æ­£ç¡®ï¼ä½ æ˜ç™½äº†æ”¿æ²»åˆ¶åº¦çš„æ¼”å˜è¿‡ç¨‹ã€‚å†å²çš„è¿ç»­æ€§å¾ˆé‡è¦ï¼"
    },
    {
        q: "Kumpulan yang menolak perjanjian persekutuan kerana Jawatankuasa Kerja tidak mempunyai wakil bukan Melayu dan menganggap ia tidak demokratik ialah:",
        options: ["UMNO", "MCA", "PUTERA-AMCJA", "API"],
        answer: "PUTERA-AMCJA",
        explain: "PUTERA-AMCJA menolak Perjanjian Persekutuan 1948 kerana menganggap Jawatankuasa Kerja tidak demokratik dan tidak mempunyai wakil bukan Melayu.",
        encourage: "å‡ºè‰²ï¼ä½ ç†è§£äº†ä¸åŒæ”¿æ²»é›†å›¢çš„ç«‹åœºã€‚å¤šå…ƒè§‚ç‚¹çš„ç†è§£å¾ˆé‡è¦ï¼"
    },
    {
        q: "Mengapakah pihak British menyokong penubuhan Persekutuan Tanah Melayu 1948?",
        options: ["Menjamin kestabilan politik", "Mengatasi ancaman ekonomi", "Mengurangkan beban kewangan", "Mengurangkan kuasa raja-raja Melayu"],
        answer: "Menjamin kestabilan politik",
        explain: "British menyokong konsep persekutuan kerana dapat mewujudkan keamanan, kestabilan dan kemajuan ekonomi di Tanah Melayu.",
        encourage: "å¾ˆå¥½ï¼ä½ ç†è§£äº†è‹±å›½æ”¯æŒPTMçš„åŠ¨æœºã€‚æ”¿æ²»ç¨³å®šç¡®å®å¾ˆé‡è¦ï¼"
    },
    {
        q: "Berdasarkan Persekutuan Tanah Melayu 1948, jus soli hanya diberikan kepada: I. Rakyat Asing II. Rakyat Raja III. Rakyat British IV. Rakyat Pribumi",
        options: ["I dan II", "I dan IV", "II dan III", "III dan IV"],
        answer: "II dan III",
        explain: "Dalam PTM 1948, jus soli hanya terbuka kepada rakyat Raja dan rakyat British sahaja, bukan kepada semua penduduk.",
        encourage: "æ­£ç¡®ï¼ä½ æŒæ¡äº†PTM 1948ä¸­å…¬æ°‘æƒçš„é‡è¦ç‰¹å¾ã€‚è¿™æ˜¯é‡å¤§çš„æ”¿æ²»å˜åŒ–ï¼"
    },
    {
        q: "Siapakah yang mengetuai pentadbiran Kerajaan Persekutuan 1948?",
        options: ["Gabenor Jeneral", "Residen Jeneral", "Residen Konsular", "Pesuruhjaya Tinggi"],
        answer: "Pesuruhjaya Tinggi",
        explain: "Kerajaan Persekutuan diketuai oleh seorang Pesuruhjaya Tinggi British, bukan lagi Gabenor seperti dalam Malayan Union.",
        encourage: "å¾ˆå¥½ï¼ä½ æ³¨æ„åˆ°äº†è¡Œæ”¿é¦–é•¿èŒä½çš„å˜åŒ–ã€‚è¿™ä¸ªç»†èŠ‚å¾ˆé‡è¦ï¼"
    },
    {
        q: "Apakah tanggungjawab sultan di peringkat negeri dalam Persekutuan Tanah Melayu 1948?",
        options: ["Menjalankan kuasa eksekutif", "Menjaga ketenteraman awam", "Mengesahkan rang undang-undang", "Menganggotai Majlis Mesyuarat Negeri"],
        answer: "Mengesahkan rang undang-undang",
        explain: "Bagi peringkat negeri, sultan bertanggungjawab mengesahkan rang undang-undang yang diluluskan dalam Dewan Perundangan Negeri.",
        encourage: "å‡ºè‰²ï¼ä½ ç†è§£äº†è‹ä¸¹åœ¨å·çº§æ”¿åºœä¸­çš„å…·ä½“èŒè´£ã€‚æƒåŠ›åˆ†é…å¾ˆæ¸…æ¥šï¼"
    },
    {
        q: "Persekutuan Tanah Melayu 1948 telah membentuk sebuah Majlis Raja-Raja. Apakah kuasa majlis tersebut?",
        options: ["Memberikan pandangan dalam perkara tertentu", "Mengesahkan keputusan Pesuruhjaya Tinggi", "Mengetuai Majlis Perundangan Persekutuan", "Meluluskan semua pindaan perlembagaan"],
        answer: "Memberikan pandangan dalam perkara tertentu",
        explain: "Majlis Raja-Raja dibentuk untuk membolehkan Raja-raja Melayu memberikan pandangan dalam perkara yang tertentu.",
        encourage: "éå¸¸å¥½ï¼ä½ æ˜ç™½äº†ç»Ÿæ²»è€…ç†äº‹ä¼šçš„å’¨è¯¢æ€§è´¨ã€‚è¿™æ˜¯é‡è¦çš„åˆ¶è¡¡æœºåˆ¶ï¼"
    },
    {
        q: "Mengapakah orang Melayu tidak menentang penubuhan Persekutuan Tanah Melayu yang ditubuhkan pada 1948?",
        options: ["Undang-undang tradisional tamat", "Kuasa Raja-raja Melayu dikembalikan", "Singapura dipisahkan daripada persekutuan", "Kaum imigran tidak diberikan taraf warganegara"],
        answer: "Kuasa Raja-raja Melayu dikembalikan",
        explain: "Orang Melayu menerima PTM 1948 kerana ia mengembalikan kedudukan dan kedaulatan Raja-raja Melayu seperti sebelum perang.",
        encourage: "å¾ˆå¥½ï¼ä½ ç†è§£äº†é©¬æ¥äººæ¥å—PTMçš„å…³é”®åŸå› ã€‚ä¸»æƒæ¢å¤å¾ˆé‡è¦ï¼"
    },
    {
        q: "Pada 1 Februari 1948, Persekutuan Tanah Melayu telah ditubuhkan secara rasmi. Apakah implikasi penubuhannya? I. Merangka sistem pendidikan yang seragam II. Mengadakan rundingan ke arah kemerdekaan III. Mengiktiraf kedudukan istimewa orang Melayu IV. Membuka jalan ke arah perpaduan kaum",
        options: ["I dan II", "I dan IV", "II dan III", "III dan IV"],
        answer: "III dan IV",
        explain: "PTM 1948 mengiktiraf kedudukan istimewa orang Melayu dan membuka jalan ke arah perpaduan serta kerjasama antara kaum.",
        encourage: "å¤ªæ£’äº†ï¼ä½ æŒæ¡äº†PTM 1948çš„é•¿è¿œå½±å“ã€‚ç¤¾ä¼šå’Œè°å¾ˆé‡è¦ï¼"
    },
    {
        q: "Antara berikut, yang manakah berkaitan dengan isi Perjanjian Persekutuan Tanah Melayu 1948? I. Hak semua kaum terjamin II. Majlis Raja-Raja dibentuk III. Pembentukan sebuah persekutuan IV. Mengiktiraf kedudukan agama Islam",
        options: ["I dan II", "I dan IV", "II dan III", "III dan IV"],
        answer: "II dan III",
        explain: "Perjanjian PTM 1948 memperuntukkan pembentukan Majlis Raja-Raja dan pembentukan sebuah persekutuan yang menggantikan Malayan Union.",
        encourage: "å‡ºè‰²ï¼ä½ èƒ½è¯†åˆ«æ¡çº¦çš„å…·ä½“å†…å®¹ã€‚æ³•å¾‹æ–‡ä»¶çš„ç†è§£å¾ˆå¥½ï¼"
    },
    {
        q: "Apakah faktor yang menyebabkan British menggantikan Malayan Union dengan Persekutuan Tanah Melayu 1948? I. Ketidakpuasan hati terhadap British II. Cadangan Raja-raja Melayu dan UMNO III. Penentangan orang Melayu terhadap Malayan Union IV. Kegagalan British mentadbir Malayan Union",
        options: ["I dan II", "I dan IV", "II dan III", "III dan IV"],
        answer: "II dan III",
        explain: "Faktor utama penubuhan PTM 1948 adalah penentangan orang Melayu terhadap Malayan Union dan cadangan Raja-raja Melayu serta UMNO untuk alternatif yang lebih sesuai.",
        encourage: "éå¸¸å¥½ï¼ä½ æŒæ¡äº†PTM 1948æˆç«‹çš„ä¸»è¦æ¨åŠ¨å› ç´ ï¼"
    },
    {
        q: "Apakah ciri-ciri utama Perjanjian Persekutuan Tanah Melayu 1948? I. Kerakyatan sama rata bagi semua II. Singapura disatukan dengan Tanah Melayu III. Kedudukan istimewa orang Melayu dilindungi IV. Pembentukan Senarai Persekutuan dan Senarai Negeri",
        options: ["I dan II", "I dan IV", "II dan III", "III dan IV"],
        answer: "III dan IV",
        explain: "Ciri utama PTM 1948 termasuk melindungi kedudukan istimewa orang Melayu dan pembentukan senarai kuasa persekutuan dan negeri.",
        encourage: "å¤ªæ£’äº†ï¼ä½ èƒ½è¯†åˆ«PTM 1948çš„å…³é”®ç‰¹å¾ã€‚åˆ¶åº¦è®¾è®¡çš„ç†è§£å¾ˆå¥½ï¼"
    },
    {
        q: "Kewarganegaraan Persekutuan Tanah Melayu (PTM) 1948 boleh diperoleh melalui 'kuatkuasa undang-undang' untuk golongan:",
        options: ["Semua penduduk Tanah Melayu", "Rakyat Raja dan Rakyat British sahaja", "Semua kaum bukan Melayu", "Penduduk yang telah naturalisasi"],
        answer: "Rakyat Raja dan Rakyat British sahaja",
        explain: "Kewarganegaraan secara kuat kuasa undang-undang diberikan kepada rakyat Raja dan rakyat British berdasarkan jus soli yang ditetapkan dalam PTM 1948.",
        encourage: "éå¸¸ä¼˜ç§€ï¼ä½ æŒæ¡äº†å…¬æ°‘æƒè·å¾—çš„é‡è¦é™åˆ¶ã€‚è¿™æ˜¯PTMçš„å…³é”®ç‰¹å¾ï¼"
    },
    {
        q: "Persekutuan Tanah Melayu 1948 telah mewujudkan kerjasama antara kaum melalui penubuhan:",
        options: ["Majlis Raja-Raja", "Communities Liaison Committee (CLC)", "Dewan Perundangan Persekutuan", "Jawatankuasa Hubungan Kaum"],
        answer: "Communities Liaison Committee (CLC)",
        explain: "PTM 1948 membuka jalan ke arah perpaduan dan kerjasama antara kaum melalui penubuhan Jawatankuasa Hubungan Antara Kaum atau Communities Liaison Committee (CLC).",
        encourage: "ä¼˜ç§€ï¼ä½ ç†è§£äº†PTMåœ¨ä¿ƒè¿›ç§æ—å’Œè°æ–¹é¢çš„åŠªåŠ›ã€‚ç¤¾ä¼šå›¢ç»“å¾ˆé‡è¦ï¼"
    }
];

function showTab(tabId) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Deactivate all tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabId).classList.add('active');
    
    // Activate selected tab
    event.currentTarget.classList.add('active');
    
    // If history tab is selected, load history
    if (tabId === 'history') {
        loadHistory();
    }
}

function submitQuiz() {
    const name = document.getElementById('name').value;
    const form = document.getElementById('form').value;
    
    if (!name || !form) {
        alert("è¯·å¡«å†™å®Œæ•´çš„ä¸ªäººä¿¡æ¯ï¼");
        return;
    }
    
    let score = 0;
    let results = [];
    let unanswered = 0;
    
    questions.forEach((q, index) => {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        const isCorrect = selected && selected.value === q.answer;
        
        if (isCorrect) score++;
        if (!selected) unanswered++;
        
        results.push({
            question: q.q,
            selected: selected ? selected.value : "æœªä½œç­”",
            correct: q.answer,
            isCorrect: isCorrect,
            explain: q.explain,
            encourage: q.encourage
        });
    });
    
    // Save the attempt to history
    saveAttempt(name, form, score, results);
    
    // Display results
    displayResults(name, form, score, results, unanswered);
}

function displayResults(name, form, score, results, unanswered) {
    let output = `
        <h3>åå­—: ${name}</h3>
        <h3>å¹´çº§: ${form}</h3>
        <h3>å¾—åˆ†: <span class="${score >= 16 ? 'correct' : 'incorrect'}">${score} / 20</span></h3>
        ${unanswered > 0 ? `<p>æ³¨æ„ï¼šä½ æœ‰ ${unanswered} é¢˜æ²¡æœ‰ä½œç­”</p>` : ''}
        <p>${getFeedback(score)}</p>
        <div class="save-buttons">
            <button class="whatsapp-btn" onclick="sendToWhatsApp('${name}', '${form}', ${score}, ${unanswered}, 'teacher')">ğŸ“± å‘é€æˆç»©ç»™è€å¸ˆ</button>
            <button class="whatsapp-btn" onclick="generateReportImage('${name}', '${form}', ${score}, ${unanswered})">ğŸ–¼ï¸ ç”Ÿæˆæˆç»©å•å›¾ç‰‡</button>
        </div>
        <div id="reportCanvas" style="margin-top: 20px;"></div>
        <hr>
    `;
    
    results.forEach((r, index) => {
        output += `
            <div class="question">
                <p><strong>ç¬¬${index + 1}é¢˜ï¼š${r.isCorrect ? 'æ­£ç¡® âœ…' : 'é”™è¯¯ âŒ'}</strong></p>
                <p>é¢˜ç›®: ${r.question}</p>
                ${!r.isCorrect ? `<p>ä½ çš„ç­”æ¡ˆ: <span class="incorrect">${r.selected}</span></p>` : ''}
                <p>æ­£ç¡®ç­”æ¡ˆ: <span class="correct">${r.correct}</span></p>
                <p>è§£é‡Š: ${r.explain}</p>
                <p>é¼“åŠ±: ${r.encourage}</p>
            </div>
        `;
    });
    
    document.getElementById('result').innerHTML = output;
    document.getElementById('result').classList.remove('hidden');
    
    // Scroll to results
    document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
}

function getFeedback(score) {
    if (score === 20) {
        return "å¤ªå‰å®³å•¦ï¼å…¨å¯¹è€¶ï¼ä½ å¯¹Persekutuan Tanah Melayu 1948çš„æŒæ¡éå¸¸å®Œç¾ï¼ğŸ‰ å†å²å­¦éœ¸å°±æ˜¯ä½ ï¼";
    } else if (score >= 18) {
        return "æˆç»©ä¼˜å¼‚ï¼ä½ å¯¹PTM 1948çš„ç†è§£å¾ˆæ·±å…¥ï¼Œåªæœ‰å°‘è®¸ç»†èŠ‚éœ€è¦æ³¨æ„ï¼âœ¨ ç»§ç»­ä¿æŒï¼";
    } else if (score >= 15) {
        return "å¾ˆä¸é”™ï¼åŸºæœ¬æ¦‚å¿µéƒ½æŒæ¡äº†ï¼Œå¯¹å†å²å‘å±•è„‰ç»œç†è§£å¾—å¾ˆå¥½ï¼ğŸ˜Š åŠ æ²¹ï¼";
    } else if (score >= 12) {
        return "æœ‰è¿›æ­¥ç©ºé—´ï¼å»ºè®®å¤šå¤ä¹ å·¥ä½œå§”å‘˜ä¼šå’Œæ”¿æ²»åˆ¶åº¦çš„å†…å®¹ï¼Œä½ ä¼šæ›´æ£’çš„ï¼ğŸ’ª";
    } else if (score >= 8) {
        return "éœ€è¦åŠ å¼ºå¤ä¹ å“¦ï¼é‡ç‚¹å…³æ³¨PTM 1948çš„æˆç«‹èƒŒæ™¯å’Œé‡è¦ç‰¹å¾ï¼ğŸ“š";
    } else {
        return "å»ºè®®é‡æ–°å­¦ä¹ è¿™ä¸ªç« èŠ‚ï¼Œå¤šçœ‹è¯¾æœ¬å’Œç¬”è®°ï¼Œå†å²éœ€è¦æ…¢æ…¢ç§¯ç´¯çš„ï¼ğŸŒ± ä¸è¦æ”¾å¼ƒï¼";
    }
}

function sendToWhatsApp(name, form, score, unanswered, recipient = 'teacher') {
    const date = new Date().toLocaleString();
    const percentage = Math.round((score / 20) * 100);
    const grade = getGrade(score);
    
    let message = '';
    let whatsappUrl = '';
    
    if (recipient === 'teacher') {
        message += `å°Šæ•¬çš„è€å¸ˆï¼Œæ‚¨å¥½ï¼\n\n`;
        message += `æˆ‘æ˜¯ ${name} (${form})ï¼Œåˆšå®Œæˆäº†F4 Sejarah Bab 5 - Persekutuan Tanah Melayu 1948æµ‹éªŒï¼Œç°å‘æ‚¨æ±‡æŠ¥æˆç»©ï¼š\n\n`;
        message += `ğŸ“Š æµ‹éªŒæˆç»©: ${score}/20 åˆ† (${percentage}%)\n`;
        message += `â­ ç­‰çº§: ${grade}\n`;
        message += `ğŸ“… æµ‹éªŒæ—¶é—´: ${date}\n`;
        if (unanswered > 0) {
            message += `âš ï¸ æœªå®Œæˆé¢˜ç›®: ${unanswered} é¢˜\n`;
        }
        message += `\nğŸ¯ æŒæ¡ç¨‹åº¦: ${getSkillLevel(score)}\n`;
        message += `\næˆ‘ä¼šç»§ç»­åŠªåŠ›å­¦ä¹ é©¬æ¥äºšå†å²ï¼Œè°¢è°¢è€å¸ˆçš„æŒ‡å¯¼ï¼`;
        
        // Encode the message for URL
        const encodedMessage = encodeURIComponent(message);
        
        // Create WhatsApp URL with specific teacher phone number
        whatsappUrl = `https://wa.me/60127317286?text=${encodedMessage}`;
        
    } else {
        // General message (fallback)
        message += `ğŸ“š F4 Sejarah Bab 5 Quiz æˆç»©æŠ¥å‘Š\n\n`;
        message += `ğŸ‘¤ å§“å: ${name}\n`;
        message += `ğŸ“ å¹´çº§: ${form}\n`;
        message += `ğŸ“… æµ‹éªŒæ—¥æœŸ: ${date}\n`;
        message += `ğŸ“Š å¾—åˆ†: ${score}/20 (${percentage}%)\n`;
        message += `â­ ç­‰çº§: ${grade}\n`;
        if (unanswered > 0) {
            message += `âš ï¸ æœªä½œç­”é¢˜ç›®: ${unanswered} é¢˜\n`;
        }
        message += `\nğŸ“ è¯„è¯­: ${getFeedback(score)}\n`;
        message += `\nğŸ¯ å†å²çŸ¥è¯†æŒæ¡ç¨‹åº¦: ${getSkillLevel(score)}\n`;
        message += `\nğŸ’ª ç»§ç»­åŠ æ²¹ï¼Œå­¦å¥½é©¬æ¥äºšå†å²ï¼`;
        
        // Encode the message for URL
        const encodedMessage = encodeURIComponent(message);
        
        // Create general WhatsApp URL
        whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
    }
    
    // Open WhatsApp
    window.open(whatsappUrl, '_blank');
}

function generateReportImage(name, form, score, unanswered) {
    // Get current quiz results for error analysis
    let wrongAnswers = [];
    questions.forEach((q, index) => {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        const isCorrect = selected && selected.value === q.answer;
        if (!isCorrect) {
            wrongAnswers.push({
                number: index + 1,
                question: q.q.substring(0, 50) + "...",
                selected: selected ? selected.value : "æœªä½œç­”",
                correct: q.answer
            });
        }
    });

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Calculate canvas height based on number of wrong answers
    const baseHeight = 800;
    const errorHeight = wrongAnswers.length * 30 + 100; // 30px per error + some padding
    canvas.width = 800;
    canvas.height = Math.max(baseHeight, baseHeight + errorHeight);
    
    // Background gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#f8f9fa');
    gradient.addColorStop(1, '#e9ecef');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Header background
    ctx.fillStyle = '#2c3e50';
    ctx.fillRect(0, 0, canvas.width, 120);
    
    // Title
    ctx.fillStyle = 'white';
    ctx.font = 'bold 28px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('F4 Sejarah Bab 5 Quiz', canvas.width/2, 45);
    ctx.font = 'bold 24px Arial';
    ctx.fillText('Persekutuan Tanah Melayu 1948', canvas.width/2, 75);
    ctx.font = '18px Arial';
    ctx.fillText('é©¬æ¥äºšè”é‚¦1948å¹´æˆç»©å•', canvas.width/2, 100);
    
    // Student Info Section
    ctx.fillStyle = '#333';
    ctx.font = 'bold 24px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('å­¦ç”Ÿä¿¡æ¯ Student Information', 50, 170);
    
    ctx.font = '20px Arial';
    ctx.fillText(`å§“å Name: ${name}`, 50, 210);
    ctx.fillText(`å¹´çº§ Form: ${form}`, 50, 240);
    ctx.fillText(`æµ‹éªŒæ—¥æœŸ Date: ${new Date().toLocaleDateString()}`, 50, 270);
    
    // Score Section
    const percentage = Math.round((score / 20) * 100);
    
    ctx.fillStyle = '#2196F3';
    ctx.font = 'bold 24px Arial';
    ctx.fillText('æµ‹éªŒæˆç»© Test Results', 50, 320);
    
    // Score circle
    const centerX = canvas.width - 150;
    const centerY = 370;
    const radius = 80;
    
    // Draw score circle background
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.fillStyle = score >= 16 ? '#4CAF50' : score >= 12 ? '#FF9800' : '#F44336';
    ctx.fill();
    
    // Score text in circle
    ctx.fillStyle = 'white';
    ctx.font = 'bold 36px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`${score}/20`, centerX, centerY - 10);
    ctx.font = 'bold 20px Arial';
    ctx.fillText(`${percentage}%`, centerX, centerY + 20);
    
    // Detailed scores
    ctx.fillStyle = '#333';
    ctx.font = '20px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(`æ€»åˆ† Total Score: ${score}/20 (${percentage}%)`, 50, 360);
    
    if (unanswered > 0) {
        ctx.fillStyle = '#F44336';
        ctx.fillText(`æœªä½œç­”é¢˜ç›® Unanswered: ${unanswered} é¢˜`, 50, 390);
    }
    
    // Performance Analysis
    ctx.fillStyle = '#333';
    ctx.font = 'bold 24px Arial';
    let currentY = unanswered > 0 ? 450 : 420;
    ctx.fillText('è¡¨ç°åˆ†æ Performance Analysis', 50, currentY);
    
    ctx.font = '18px Arial';
    const feedback = getFeedback(score);
    const words = feedback.split(' ');
    let line = '';
    currentY += 30;
    
    for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        const testWidth = metrics.width;
        if (testWidth > 700 && n > 0) {
            ctx.fillText(line, 50, currentY);
            line = words[n] + ' ';
            currentY += 25;
        } else {
            line = testLine;
        }
    }
    ctx.fillText(line, 50, currentY);
    
    // Wrong Answers Section (show ALL wrong answers)
    if (wrongAnswers.length > 0) {
        currentY += 50;
        ctx.fillStyle = '#F44336';
        ctx.font = 'bold 20px Arial';
        ctx.fillText(`é”™é¢˜åˆ†æ Wrong Answers (${wrongAnswers.length} é¢˜)`, 50, currentY);
        
        ctx.fillStyle = '#333';
        ctx.font = '16px Arial';
        
        // Show ALL wrong answers
        wrongAnswers.forEach((error, index) => {
            currentY += 30;
            ctx.fillText(`${index + 1}. ç¬¬${error.number}é¢˜: ${error.selected} â†’ ${error.correct}`, 50, currentY);
        });
    }
    
    // Footer
    ctx.fillStyle = '#666';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('ç»§ç»­åŠ æ²¹ï¼Œå­¦å¥½é©¬æ¥äºšå†å²ï¼Keep studying Malaysian History!', canvas.width/2, canvas.height - 30);
    
    // Display canvas and download options
    const reportDiv = document.getElementById('reportCanvas');
    reportDiv.innerHTML = `
        <div class="canvas-container">
            <h3>ğŸ“‹ æˆç»©å•å·²ç”Ÿæˆ</h3>
            <canvas id="generatedCanvas" width="800" height="${canvas.height}" style="max-width: 100%; height: auto; border: 1px solid #ddd;"></canvas>
            <div style="margin-top: 15px;">
                <button class="download-btn" onclick="downloadReportImage()">ğŸ’¾ ä¸‹è½½å›¾ç‰‡</button>
                <button class="whatsapp-btn" onclick="shareReportImage()">ğŸ“± å‘é€ç»™è€å¸ˆ</button>
            </div>
            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                ğŸ’¡ æç¤ºï¼šç‚¹å‡»"ä¸‹è½½å›¾ç‰‡"ä¿å­˜åˆ°è®¾å¤‡ï¼Œæˆ–ç‚¹å‡»"å‘é€ç»™è€å¸ˆ"ç›´æ¥é€šè¿‡WhatsAppå‘é€
            </p>
        </div>
    `;
    
    // Copy canvas content to displayed canvas
    const displayCanvas = document.getElementById('generatedCanvas');
    displayCanvas.height = canvas.height;
    const displayCtx = displayCanvas.getContext('2d');
    displayCtx.drawImage(canvas, 0, 0);
    
    // Store canvas globally for download
    window.reportCanvas = canvas;
    
    // Scroll to canvas
    reportDiv.scrollIntoView({ behavior: 'smooth' });
}

function downloadReportImage() {
    if (window.reportCanvas) {
        const link = document.createElement('a');
        link.download = `F4_Sejarah_Bab5_æˆç»©å•_${new Date().toISOString().split('T')[0]}.png`;
        link.href = window.reportCanvas.toDataURL();
        link.click();
    }
}

function shareReportImage() {
    if (navigator.share && window.reportCanvas) {
        // Convert canvas to blob
        window.reportCanvas.toBlob(function(blob) {
            const file = new File([blob], 'F4_Sejarah_Bab5_æˆç»©å•.png', { type: 'image/png' });
            navigator.share({
                title: 'F4 Sejarah Bab 5 Quiz æˆç»©å•',
                text: 'æˆ‘çš„é©¬æ¥äºšå†å²æµ‹éªŒæˆç»©å•',
                files: [file]
            }).catch(err => {
                console.log('åˆ†äº«å¤±è´¥:', err);
                // Fallback to download
                downloadReportImage();
            });
        });
    } else {
        // Fallback: open WhatsApp with instruction to teacher
        const message = encodeURIComponent('è€å¸ˆæ‚¨å¥½ï¼æˆ‘åˆšç”Ÿæˆäº†F4 Sejarah Bab 5æµ‹éªŒæˆç»©å•å›¾ç‰‡ï¼Œè¯·æŸ¥çœ‹æˆ‘å‘é€çš„å›¾ç‰‡ ğŸ“‹âœ¨');
        window.open(`https://wa.me/60127317286?text=${message}`, '_blank');
        alert('è¯·æ‰‹åŠ¨ä¸‹è½½å›¾ç‰‡ï¼Œç„¶ååœ¨WhatsAppä¸­å‘é€ç»™è€å¸ˆ ğŸ“±');
    }
}

function getGrade(score) {
    if (score >= 19) return "A+ ä¼˜ç§€";
    if (score >= 17) return "A è‰¯å¥½";  
    if (score >= 15) return "B+ ä¸é”™";
    if (score >= 13) return "B åŠæ ¼";
    if (score >= 10) return "C+ éœ€è¦åŠªåŠ›";
    if (score >= 8) return "C éœ€è¦åŠ å¼º";
    return "D éœ€è¦é‡æ–°å­¦ä¹ ";
}

function getSkillLevel(score) {
    if (score >= 18) return "å†å²ä¸“å®¶çº§ ğŸŒŸ";
    if (score >= 15) return "å†å²ç†Ÿç»ƒçº§ â­";
    if (score >= 12) return "å†å²ä¸­çº§ ğŸ“š";
    if (score >= 8) return "å†å²åˆçº§ ğŸ“–";
    return "å†å²å…¥é—¨çº§ ğŸ”°";
}

function saveAttempt(name, form, score, results) {
    const attempts = JSON.parse(localStorage.getItem('sejarahBab5QuizAttempts') || '[]');
    const attempt = {
        date: new Date().toLocaleString(),
        name,
        form,
        score,
        results
    };
    
    attempts.unshift(attempt); // Add new attempt at beginning
    localStorage.setItem('sejarahBab5QuizAttempts', JSON.stringify(attempts));
}

function loadHistory() {
    const attempts = JSON.parse(localStorage.getItem('sejarahBab5QuizAttempts') || '[]');
    const historyList = document.getElementById('historyList');
    
    if (attempts.length === 0) {
        historyList.innerHTML = "<p>ä½ è¿˜æ²¡æœ‰ä»»ä½•æµ‹éªŒè®°å½•ï¼Œå¿«å»åšæµ‹éªŒå§ï¼</p>";
        return;
    }
    
    let html = "";
    attempts.forEach((attempt, index) => {
        html += `
            <div class="question" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px;">
                <h3>æµ‹éªŒ #${index + 1} - ${attempt.date}</h3>
                <p>å§“å: ${attempt.name} | å¹´çº§: ${attempt.form}</p>
                <p>å¾—åˆ†: <strong>${attempt.score} / 20</strong></p>
                <button onclick="viewAttemptDetails(${index})">æŸ¥çœ‹è¯¦æƒ…</button>
                <div style="margin-top: 10px;">
                    <button class="whatsapp-btn" onclick="sendHistoryToWhatsApp(${index}, 'teacher')" style="font-size: 12px; padding: 8px 12px;">ğŸ“± å‘é€æˆç»©ç»™è€å¸ˆ</button>
                    <button class="download-btn" onclick="generateHistoryReportImage(${index})" style="font-size: 12px; padding: 8px 12px;">ğŸ–¼ï¸ ç”Ÿæˆæˆç»©å•å›¾ç‰‡</button>
                </div>
                <div id="attemptDetails${index}" style="display: none; margin-top: 10px;">
                    ${attempt.results.map((r, qIndex) => `
                        <div style="margin-bottom: 15px; padding: 10px; background: ${r.isCorrect ? '#e6ffe6' : '#ffe6e6'}; border-radius: 5px;">
                            <p><strong>ç¬¬${qIndex + 1}é¢˜ï¼š${r.isCorrect ? 'æ­£ç¡® âœ…' : 'é”™è¯¯ âŒ'}</strong></p>
                            <p>é¢˜ç›®: ${r.question}</p>
                            ${!r.isCorrect ? `<p>ä½ çš„ç­”æ¡ˆ: ${r.selected}</p>` : ''}
                            <p>æ­£ç¡®ç­”æ¡ˆ: ${r.correct}</p>
                            <p>è§£é‡Š: ${r.explain}</p>
                            <p>é¼“åŠ±: ${r.encourage}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    historyList.innerHTML = html;
}

function sendHistoryToWhatsApp(attemptIndex, recipient = 'teacher') {
    const attempts = JSON.parse(localStorage.getItem('sejarahBab5QuizAttempts') || '[]');
    const attempt = attempts[attemptIndex];
    
    if (!attempt) {
        alert("æ‰¾ä¸åˆ°è¯¥æµ‹éªŒè®°å½•ï¼");
        return;
    }
    
    const percentage = Math.round((attempt.score / 20) * 100);
    const grade = getGrade(attempt.score);
    const unanswered = attempt.results.filter(r => r.selected === "æœªä½œç­”").length;
    
    let message = '';
    let whatsappUrl = '';
    
    if (recipient === 'teacher') {
        message += `å°Šæ•¬çš„è€å¸ˆï¼Œæ‚¨å¥½ï¼\n\n`;
        message += `æˆ‘æ˜¯ ${attempt.name} (${attempt.form})ï¼Œå‘æ‚¨æ±‡æŠ¥F4 Sejarah Bab 5æµ‹éªŒæˆç»©ï¼š\n\n`;
        message += `ğŸ“Š æµ‹éªŒæˆç»©: ${attempt.score}/20 åˆ† (${percentage}%)\n`;
        message += `â­ ç­‰çº§: ${grade}\n`;
        message += `ğŸ“… æµ‹éªŒæ—¶é—´: ${attempt.date}\n`;
        if (unanswered > 0) {
            message += `âš ï¸ æœªå®Œæˆé¢˜ç›®: ${unanswered} é¢˜\n`;
        }
        message += `\nğŸ¯ æŒæ¡ç¨‹åº¦: ${getSkillLevel(attempt.score)}\n`;
        
        // Add wrong answers for teacher
        const wrongAnswers = attempt.results.filter(r => !r.isCorrect);
        if (wrongAnswers.length > 0) {
            message += `\nâŒ éœ€è¦åŠ å¼ºçš„çŸ¥è¯†ç‚¹:\n`;
            wrongAnswers.slice(0, 3).forEach((r, index) => {
                const qNum = attempt.results.indexOf(r) + 1;
                message += `${index + 1}. ç¬¬${qNum}é¢˜: é€‰æ‹©äº†"${r.selected}"ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯"${r.correct}"\n`;
            });
            if (wrongAnswers.length > 3) {
                message += `... è¿˜æœ‰ ${wrongAnswers.length - 3} é“éœ€è¦å¤ä¹ \n`;
            }
        }
        
        message += `\næˆ‘ä¼šé’ˆå¯¹é”™é¢˜è¿›è¡Œå¤ä¹ ï¼Œè°¢è°¢è€å¸ˆçš„æŒ‡å¯¼ï¼`;
        
        // Encode the message for URL
        const encodedMessage = encodeURIComponent(message);
        
        // Create WhatsApp URL with specific teacher phone number
        whatsappUrl = `https://wa.me/60127317286?text=${encodedMessage}`;
        
    } else {
        // General message
        message += `ğŸ“š F4 Sejarah Bab 5 Quiz æˆç»©æŠ¥å‘Š\n\n`;
        message += `ğŸ‘¤ å§“å: ${attempt.name}\n`;
        message += `ğŸ“ å¹´çº§: ${attempt.form}\n`;
        message += `ğŸ“… æµ‹éªŒæ—¥æœŸ: ${attempt.date}\n`;
        message += `ğŸ“Š å¾—åˆ†: ${attempt.score}/20 (${percentage}%)\n`;
        message += `â­ ç­‰çº§: ${grade}\n`;
        
        if (unanswered > 0) {
            message += `âš ï¸ æœªä½œç­”é¢˜ç›®: ${unanswered} é¢˜\n`;
        }
        
        message += `\nğŸ“ è¯„è¯­: ${getFeedback(attempt.score)}\n`;
        message += `\nğŸ¯ å†å²çŸ¥è¯†æŒæ¡ç¨‹åº¦: ${getSkillLevel(attempt.score)}\n`;
        
        // Add wrong answers details
        const wrongAnswers = attempt.results.filter(r => !r.isCorrect);
        if (wrongAnswers.length > 0) {
            message += `\nâŒ é”™é¢˜åˆ†æ:\n`;
            wrongAnswers.slice(0, 3).forEach((r, index) => {
                const qNum = attempt.results.indexOf(r) + 1;
                message += `${index + 1}. ç¬¬${qNum}é¢˜: ${r.selected} â†’ ${r.correct}\n`;
            });
            if (wrongAnswers.length > 3) {
                message += `... è¿˜æœ‰ ${wrongAnswers.length - 3} é“é”™é¢˜\n`;
            }
        }
        
        message += `\nğŸ’ª ç»§ç»­åŠ æ²¹ï¼Œå­¦å¥½é©¬æ¥äºšå†å²ï¼`;
        
        // Encode the message for URL
        const encodedMessage = encodeURIComponent(message);
        
        // Create general WhatsApp URL
        whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
    }
    
    // Open WhatsApp
    window.open(whatsappUrl, '_blank');
}

function generateHistoryReportImage(attemptIndex) {
    const attempts = JSON.parse(localStorage.getItem('sejarahBab5QuizAttempts') || '[]');
    const attempt = attempts[attemptIndex];
    
    if (!attempt) {
        alert("æ‰¾ä¸åˆ°è¯¥æµ‹éªŒè®°å½•ï¼");
        return;
    }
    
    const unanswered = attempt.results.filter(r => r.selected === "æœªä½œç­”").length;
    const wrongAnswers = attempt.results.filter(r => !r.isCorrect).map((r, index) => ({
        number: attempt.results.indexOf(r) + 1,
        question: r.question.substring(0, 50) + "...",
        selected: r.selected,
        correct: r.correct
    }));

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Calculate canvas height based on number of wrong answers
    const baseHeight = 800;
    const errorHeight = wrongAnswers.length * 30 + 100;
    canvas.width = 800;
    canvas.height = Math.max(baseHeight, baseHeight + errorHeight);
    
    // Background gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#f8f9fa');
    gradient.addColorStop(1, '#e9ecef');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Header background
    ctx.fillStyle = '#2c3e50';
    ctx.fillRect(0, 0, canvas.width, 120);
    
    // Title
    ctx.fillStyle = 'white';
    ctx.font = 'bold 28px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('F4 Sejarah Bab 5 Quiz', canvas.width/2, 45);
    ctx.font = 'bold 24px Arial';
    ctx.fillText('Persekutuan Tanah Melayu 1948', canvas.width/2, 75);
    ctx.font = '18px Arial';
    ctx.fillText('é©¬æ¥äºšè”é‚¦1948å¹´æˆç»©å•', canvas.width/2, 100);
    
    // Student Info Section
    ctx.fillStyle = '#333';
    ctx.font = 'bold 24px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('å­¦ç”Ÿä¿¡æ¯ Student Information', 50, 170);
    
    ctx.font = '20px Arial';
    ctx.fillText(`å§“å Name: ${attempt.name}`, 50, 210);
    ctx.fillText(`å¹´çº§ Form: ${attempt.form}`, 50, 240);
    ctx.fillText(`æµ‹éªŒæ—¥æœŸ Date: ${attempt.date}`, 50, 270);
    
    // Score Section
    const percentage = Math.round((attempt.score / 20) * 100);
    
    ctx.fillStyle = '#2196F3';
    ctx.font = 'bold 24px Arial';
    ctx.fillText('æµ‹éªŒæˆç»© Test Results', 50, 320);
    
    // Score circle
    const centerX = canvas.width - 150;
    const centerY = 370;
    const radius = 80;
    
    // Draw score circle background
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.fillStyle = attempt.score >= 16 ? '#4CAF50' : attempt.score >= 12 ? '#FF9800' : '#F44336';
    ctx.fill();
    
    // Score text in circle
    ctx.fillStyle = 'white';
    ctx.font = 'bold 36px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`${attempt.score}/20`, centerX, centerY - 10);
    ctx.font = 'bold 20px Arial';
    ctx.fillText(`${percentage}%`, centerX, centerY + 20);
    
    // Detailed scores
    ctx.fillStyle = '#333';
    ctx.font = '20px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(`æ€»åˆ† Total Score: ${attempt.score}/20 (${percentage}%)`, 50, 360);
    
    if (unanswered > 0) {
        ctx.fillStyle = '#F44336';
        ctx.fillText(`æœªä½œç­”é¢˜ç›® Unanswered: ${unanswered} é¢˜`, 50, 390);
    }
    
    // Performance Analysis
    ctx.fillStyle = '#333';
    ctx.font = 'bold 24px Arial';
    let currentY = unanswered > 0 ? 450 : 420;
    ctx.fillText('è¡¨ç°åˆ†æ Performance Analysis', 50, currentY);
    
    ctx.font = '18px Arial';
    const feedback = getFeedback(attempt.score);
    const words = feedback.split(' ');
    let line = '';
    currentY += 30;
    
    for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        const testWidth = metrics.width;
        if (testWidth > 700 && n > 0) {
            ctx.fillText(line, 50, currentY);
            line = words[n] + ' ';
            currentY += 25;
        } else {
            line = testLine;
        }
    }
    ctx.fillText(line, 50, currentY);
    
    // Wrong Answers Section
    if (wrongAnswers.length > 0) {
        currentY += 50;
        ctx.fillStyle = '#F44336';
        ctx.font = 'bold 20px Arial';
        ctx.fillText(`é”™é¢˜åˆ†æ Wrong Answers (${wrongAnswers.length} é¢˜)`, 50, currentY);
        
        ctx.fillStyle = '#333';
        ctx.font = '16px Arial';
        
        wrongAnswers.forEach((error, index) => {
            currentY += 30;
            ctx.fillText(`${index + 1}. ç¬¬${error.number}é¢˜: ${error.selected} â†’ ${error.correct}`, 50, currentY);
        });
    }
    
    // Footer
    ctx.fillStyle = '#666';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('ç»§ç»­åŠ æ²¹ï¼Œå­¦å¥½é©¬æ¥äºšå†å²ï¼Keep studying Malaysian History!', canvas.width/2, canvas.height - 30);
    
    // Create download link
    const link = document.createElement('a');
    link.download = `F4_Sejarah_Bab5_æˆç»©å•_${attempt.name}_${attempt.date.replace(/[/:]/g, '-')}.png`;
    link.href = canvas.toDataURL();
    link.click();
    
    // Also show success message
    alert('æˆç»©å•å›¾ç‰‡å·²ä¸‹è½½ï¼æ‚¨å¯ä»¥é€šè¿‡WhatsAppå‘é€ç»™è€å¸ˆ ğŸ“±');
}

function viewAttemptDetails(index) {
    const detailsDiv = document.getElementById(`attemptDetails${index}`);
    if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
    } else {
        detailsDiv.style.display = 'none';
    }
}

function saveProgress() {
    const name = document.getElementById('name').value;
    const form = document.getElementById('form').value;
    
    if (!name || !form) {
        alert("è¯·å…ˆå¡«å†™ä¸ªäººä¿¡æ¯ï¼");
        return;
    }
    
    const progress = {
        name,
        form,
        answers: []
    };
    
    questions.forEach((q, index) => {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        progress.answers.push(selected ? selected.value : null);
    });
    
    localStorage.setItem('sejarahBab5QuizProgress', JSON.stringify(progress));
    alert("è¿›åº¦å·²ä¿å­˜ï¼ä½ å¯ä»¥ç¨åå›æ¥ç»§ç»­å®Œæˆæµ‹éªŒã€‚");
}

function loadProgress() {
    const progress = JSON.parse(localStorage.getItem('sejarahBab5QuizProgress'));
    
    if (!progress) {
        alert("æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„è¿›åº¦ï¼");
        return;
    }
    
    document.getElementById('name').value = progress.name;
    document.getElementById('form').value = progress.form;
    
    progress.answers.forEach((answer, index) => {
        if (answer) {
            const radio = document.querySelector(`input[name="q${index}"][value="${answer}"]`);
            if (radio) radio.checked = true;
        }
    });
    
    alert("è¿›åº¦å·²åŠ è½½ï¼ä½ å¯ä»¥ç»§ç»­å®Œæˆæµ‹éªŒã€‚");
}

window.onload = function() {
    const qDiv = document.getElementById('questions');
    questions.forEach((q, index) => {
        const div = document.createElement('div');
        div.className = "question";
        div.innerHTML = `<p><strong>ç¬¬${index + 1}é¢˜.</strong> ${q.q}</p>` +
                        q.options.map(opt => `
                            <label><input type="radio" name="q${index}" value="${opt}"> ${opt}</label><br>
                        `).join('');
        qDiv.appendChild(div);
    });
    
    // Check if there's saved progress
    if (localStorage.getItem('sejarahBab5QuizProgress')) {
        if (confirm("æ£€æµ‹åˆ°æœ‰ä¿å­˜çš„è¿›åº¦ï¼Œæ˜¯å¦åŠ è½½ï¼Ÿ")) {
            loadProgress();
        }
    }
}
</script>

</body>
</html>